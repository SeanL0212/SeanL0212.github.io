{"type":"document","children":[{"type":"heading","children":[{"type":"text","content":"Hash Indexes "},{"type":"emphasis","children":[{"type":"text","content":"72"}]}],"attributes":{"id":"hash-indexes-72","level":1}},{"type":"paragraph","children":[{"type":"text","content":"Hash maps are widely used in programming languages, and the hash indexes is just the application of it on disk. The hash indexes keep maps of key-value pairs, whose keys are short marks while values are byte offset."}]},{"type":"paragraph","children":[{"type":"text"},{"type":"image","children":[{"type":"text","content":"store_a_hash_map"}],"attributes":{"alt":"","src":"./1.png"}}]},{"type":"paragraph","children":[{"type":"text","content":"Hash maps are loaded in cache in advance from file system, so it is quite fast. While this can not last for long, because the cache will be used up one day. Let us take a example to see how to cope with it."}]},{"type":"heading","children":[{"type":"text","content":"Data File Segment "},{"type":"emphasis","children":[{"type":"text","content":"p73"}]}],"attributes":{"id":"data-file-segment-p73","level":2}},{"type":"blockQuote","children":[{"type":"paragraph","children":[{"type":"text","content":"the key might be the URL of a cat video, and the value  might  be  the  number  of  times  it  has  been  played  (incremented  every  time someone hits the play button). In this kind of workload, there are a lot of writes, but there are not too many distinct keysâ€”you have a large number of writes per key, but it's feasible to keep all keys in memory."}]}]},{"type":"paragraph","children":[{"type":"text","content":"To record these data, we first allocate several space log the data separately. For example, we log the hits of different videos like below:"}]},{"type":"table","children":[{"type":"tableHead","children":[{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"Video"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"Hits"}],"attributes":{"align":"right"}}]}]},{"type":"tableBody","children":[{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"mew"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"1078"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"purr"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"2103"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"purr"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"2104"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"mew"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"1079"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"mew"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"1080"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"mew"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"1081"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"purr"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"2105"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"purr"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"2106"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"purr"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"2107"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"yawn"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"511"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"purr"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"2108"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"mew"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"1082"}],"attributes":{"align":"right"}}]}]}]},{"type":"paragraph","children":[{"type":"text","content":"Now it runs up the space of this part, we need to perform "},{"type":"emphasis","children":[{"type":"text","content":"compaction"}]},{"type":"text","content":" to it"}]},{"type":"table","children":[{"type":"tableHead","children":[{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"Video"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"Hits"}],"attributes":{"align":"right"}}]}]},{"type":"tableBody","children":[{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"yawn"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"511"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"mew"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"1082"}],"attributes":{"align":"right"}}]},{"type":"tableRow","children":[{"type":"tableCell","children":[{"type":"text","content":"purr"}],"attributes":{"align":"center"}},{"type":"tableCell","children":[{"type":"text","content":"2108"}],"attributes":{"align":"right"}}]}]}]},{"type":"paragraph","children":[{"type":"text","content":"Once we collect the data, we can release the space. This is the procedure happens on one segment. If those segments are pretty small, we can perform the compaction once 2 or 3 segments."}]},{"type":"heading","children":[{"type":"text","content":"Several Issues about Implementation "},{"type":"emphasis","children":[{"type":"text","content":"p74"}]}],"attributes":{"id":"several-issues-about-implementation-p74","level":2}},{"type":"paragraph","children":[{"type":"text","content":"There are lots of details to make this idea work in practice."}]},{"type":"list","children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"File format"}]},{"type":"list","children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text"},{"type":"strong","children":[{"type":"text","content":"Binary"}]},{"type":"text","content":" format that first encodes the length of a string in bytes, followed by the raw string("},{"type":"strong","children":[{"type":"text","content":"without"}]},{"type":"text","content":" need for "},{"type":"strong","children":[{"type":"text","content":"escaping"}]},{"type":"text","content":"), like a pagination operation using offset and limit"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"CSV or something like it is not the best since they have escaping characters"}]}]}],"attributes":{"ordered":false,"tight":true}}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"Deleting records"}]},{"type":"list","children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"This is an append-only log, so delete or update "},{"type":"strong","children":[{"type":"text","content":"in place is impossible"}]},{"type":"text","content":". The only way to delete records is to append a special deletion record to it(sometimes called a "},{"type":"emphasis","children":[{"type":"text","content":"tombstone"}]},{"type":"text","content":"). When the logs are merged, the merging precess will ignore the logs related to the tombstone"}]}]}],"attributes":{"ordered":false,"tight":true}}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"Crash recovery"}]},{"type":"list","children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"When a crash happens, all the in-memory data(the hash maps) are lost. Though it is viable to restore them by reading the "},{"type":"strong","children":[{"type":"text","content":"entire segment file"}]},{"type":"text","content":", that takes a long time. To fix this, some application(e.g. Bitcask) introduce "},{"type":"strong","children":[{"type":"text","content":"snapshots"}]},{"type":"text"}]}]}],"attributes":{"ordered":false,"tight":true}}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"Partially written records"}]},{"type":"list","children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"Crashes can happen anytime, which may make the data inconsistent. To fix this, we can use checksums(what Bitcask does)"}]}]}],"attributes":{"ordered":false,"tight":true}}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"Concurrency control"}]},{"type":"list","children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"This is a widely discussed issue. One feasible way is "},{"type":"strong","children":[{"type":"text","content":"lock"}]},{"type":"text","content":" the file so that there is always only "},{"type":"strong","children":[{"type":"text","content":"one write thread"}]},{"type":"text"}]}]}],"attributes":{"ordered":false,"tight":true}}]}],"attributes":{"ordered":true,"tight":true}},{"type":"heading","children":[{"type":"text","content":"Pros and Cons "},{"type":"emphasis","children":[{"type":"text","content":"p75"}]}],"attributes":{"id":"pros-and-cons-p75","level":2}},{"type":"paragraph","children":[{"type":"text","content":"Pros:"}]},{"type":"list","children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"Appending and segment merging are "},{"type":"strong","children":[{"type":"text","content":"sequential"}]},{"type":"text","content":" write operations, which are generally much faster than "},{"type":"strong","children":[{"type":"text","content":"random"}]},{"type":"text","content":" writes, especially on "},{"type":"strong","children":[{"type":"text","content":"magnetic spinning-disk hard drives"}]},{"type":"text","content":"."}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"Concurrency  and  crash  recovery  are  much  simpler  if  segment  files  are  append-only or immutable. That means no "},{"type":"strong","children":[{"type":"text","content":"silent corruption"}]},{"type":"text","content":", only at most "},{"type":"strong","children":[{"type":"text","content":"truncation/loss"}]},{"type":"text","content":" of the latest writes."}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"Merging  old  segments  "},{"type":"strong","children":[{"type":"text","content":"avoid"}]},{"type":"text","content":"s  the  problem  of  data  files  getting  "},{"type":"strong","children":[{"type":"text","content":"fragmented"}]},{"type":"text","content":" over time."}]}]}],"attributes":{"ordered":false,"tight":true}},{"type":"paragraph","children":[{"type":"text","content":"Cons:"}]},{"type":"list","children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"The  hash  table  must  fit  in  "},{"type":"strong","children":[{"type":"text","content":"memory"}]},{"type":"text","content":". Though it is viable to maintain a hash map on "},{"type":"strong","children":[{"type":"text","content":"disk"}]},{"type":"text","content":", that performance will not good."}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","content":"Range queries are "},{"type":"strong","children":[{"type":"text","content":"not efficient"}]},{"type":"text","content":". That is due to hash, since hash function will project the keys into different hashed values then break the order."}]}]}],"attributes":{"ordered":false,"tight":true}}],"attributes":{"date":"2025-09-20","tags":["book","designing data intensive applications"],"title":"Hash Indexes"}}